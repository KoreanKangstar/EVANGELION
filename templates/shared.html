<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>🌐 Shared Files - EVANGELION EdgeNAS</title>
  <style>
    body { font-family: 'Inter', sans-serif; background: #0f111a; color:#eee; margin:0; padding:2rem; }
    h2 { color:#7bdcb5; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; }
    .topbar a { color:#7bdcb5; text-decoration:none; font-weight:600; margin-left:1rem; }
    .topbar a.logout { color:#ff6b6b; }
    .date-group { margin-bottom:2rem; }
    .date-group h3 { color:#63c3a0; margin-bottom:0.5rem; }
    .file-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:1rem; }
    .file-card { background:#1e2230; border-radius:10px; padding:1rem; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.3); }
    img.preview, video.preview { width:120px; height:120px; object-fit:cover; border-radius:8px; }
    .actions a { color:#7bdcb5; text-decoration:none; margin:0 4px; }
    .actions a:hover { text-decoration:underline; }
    #upload-zone { border:2px dashed #7bdcb5; border-radius:10px; width:50%; height:300px; margin:2rem auto;
                   display:flex; justify-content:center; align-items:center; text-align:center; cursor:pointer; }
    #upload-zone.dragover { background:rgba(123,220,181,0.1); transform:scale(1.02); border-color:#63c3a0; }
  </style>
</head>

<body>
  <div class="topbar">
    <h2>🌐 Shared Files</h2>
    <div>
      <a href="/personal/">📁 Personal Storage</a>
      <a href="/shared/trash">🗑 Trash</a>
      <a class="logout" href="/auth/logout">Logout</a>
    </div>
  </div>

  <div id="upload-zone">
    📤 Drag & Drop files here<br>or click to upload
  </div>

  <form id="uploadForm" action="/shared/upload" method="post" enctype="multipart/form-data" style="display:none;">
    <input id="fileInput" type="file" name="file" onchange="this.form.submit()">
  </form>

  <div id="shared-container">불러오는 중...</div>

  <script>
    // 클릭 업로드
    const zone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('fileInput');
    zone.addEventListener('click', () => fileInput.click());

    // DnD 업로드
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) uploadFile(files[0]);
    });

    async function uploadFile(file) {
      const fd = new FormData();
      fd.append('file', file);
      await fetch('/shared/upload', { method: 'POST', body: fd });
      await refreshSharedFiles();
    }

    async function refreshSharedFiles() {
      const res = await fetch('/shared/files');
      if (!res.ok) { document.getElementById('shared-container').innerText = "파일 불러오기 실패"; return; }
      const grouped = await res.json();
      const container = document.getElementById('shared-container');
      container.innerHTML = '';

      if (Object.keys(grouped).length === 0) {
        container.innerHTML = '<p>공유된 파일이 없습니다.</p>';
        return;
      }

      for (const [date, files] of Object.entries(grouped)) {
        const section = document.createElement('div');
        section.className = 'date-group';
        section.innerHTML = `<h3>${date}</h3><div class="file-grid"></div>`;
        const grid = section.querySelector('.file-grid');

        files.forEach(f => {
          const card = document.createElement('div');
          card.className = 'file-card';
          let media = '';
          if (f.is_image) {
            media = `<img class="preview" src="/shared/download/${f.name}" alt="preview">`;
          } else if (f.is_video) {
            media = `<video class="preview" src="/shared/download/${f.name}" controls></video>`;
          }
          card.innerHTML = `
            ${media}
            <div><strong>${f.name}</strong></div>
            <small>${f.uploader} • ${f.time}</small>
            <div class="actions">
              <a href="/shared/download/${f.name}">다운로드</a>
              <a href="#" onclick="deleteFile('${f.name}')">삭제</a>
            </div>`;
          grid.appendChild(card);
        });

        container.appendChild(section);
      }
    }

    async function deleteFile(name) {
      if (!confirm(`'${name}'을(를) 휴지통으로 이동하시겠습니까?`)) return;
      const res = await fetch(`/shared/delete/${name}`, { method: 'DELETE' });
      if (res.ok) {
        alert("삭제되었습니다 (휴지통으로 이동).");
        refreshSharedFiles();
      } else {
        alert("삭제 실패!");
      }
    }

    refreshSharedFiles();
  </script>
</body>
</html>



